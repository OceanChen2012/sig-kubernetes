---
draft: false
profile: 华北电力大学大四学生。
keywords:
  - Kubernetes
  - APIServer
author: '[杨鼎睿](https://yuque.com/abser)'
date: '2021-05-06T17:04:05.000Z'
title: Kubernetes APIServer Storage 架构设计源码阅读
tags:
  - Kubernetes
  - 源码架构图
  - APIServer
avatar: /images/profile/abserari.png
type: post
image: /images/blog/kubernetes-apiserver.png
categories:
  - kubernetes
description: '本文研究了 Storage 部分的源码，配备源码进行进一步理解，可以加深理解,增强相关设计能力。'
---

# API Server Storage

This paper studies the source code of the **Storage** section. You should read the source code at the same time. It can enhance your design capacity.

## StorageFactory

The role of StorageFactory is to encapsulate and simplify operations on resources. The main function of StorageFactory is to obtain the storage configuration Config corresponding to the resource according to the incoming GroupResource.

![storage-storage-factory.svg](../.gitbook/assets/12%20%281%29.png)

In the API Server, StorageFactory is generated by StorageFactoryConfig, and StorageFactoryConfig is generated by EtcdOption. After all, no matter what changes, etcd storage is the final destination.

![image.png](../.gitbook/assets/13%20%281%29.png)

### DefaultStorageFactory

DefaultStorageFactory is the only implementation of K8S internal StorageFactory before version 1.18. Let's analyze the mode of DefaultStorageFactory in detail.

#### Cohabitating Resources

![storage-cohabitating-resources.svg](../.gitbook/assets/14%20%281%29.png)

The DefaultStorageFactory organizes the associated GroupResources together. As you can see from the above figure, each incoming GroupResource is processed in turn. Therefore, there are also priority issues among the associated GroupResources. The following figure shows the configuration of associated resources in the StorageFactory used when kube-apiserver is created.

![image.png](../.gitbook/assets/15%20%281%29.png)

### RESTOptionsGetter

Etcd configuration and StorageFactory are finally imported into RESTOptionsGetter. RESTOptionsGetter is used as the core configuration item to find the final storage through GroupResource.

![image.png](../.gitbook/assets/16.png)

The process of creating storage. The interface is shown in the figure below.

![rest-options-getter-landscape.svg](../.gitbook/assets/17.png)

#### StorageFactoryRestOptionFactory

Taking StorageFactoryRestOptionFactory as an example, the steps of the GetRESTOptions method are as follows.

* Use StorageFactory to generate Storage Config.
* Create a RESTOptions structure and save the generated Storage Config.
* Use generic.UndecoratedStorage method as a decorator by default.
* If the EnableWatchCache option is turned on, the Decorator will be modified.

![image.png](../.gitbook/assets/18%20%282%29.png)

#### UndecoratedStorage

UndecoratedStorage only uses the passed storagebackend.Config parameter

![image.png](../.gitbook/assets/19%20%283%29.png)

Call factory.Create directly to create the back-end storage.

![image.png](../.gitbook/assets/20.png)

